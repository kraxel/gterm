stages:
  - build
  - rpms
  - repo

.build_meson: &build_meson
  - mkdir build-meson
  - meson . build-meson
  - ninja-build -C build-meson

build_fedora:
  stage: build
  image: registry.gitlab.com/kraxel/rpm-package-builder:fedora
  before_script:
    - dnf builddep -y *.spec
  script:
    - *build_meson

build_centos8:
  stage: build
  image: registry.gitlab.com/kraxel/rpm-package-builder:centos8
  before_script:
    - dnf builddep -y *.spec
  script:
    - *build_meson

build_centos7:
  stage: build
  image: registry.gitlab.com/kraxel/rpm-package-builder:centos7
  before_script:
    - yum-builddep -y *.spec
  script:
    - *build_meson

tito_fedora:
  stage: rpms
  image: registry.gitlab.com/kraxel/rpm-package-builder:fedora
  before_script:
    - dnf builddep -y *.spec
  script:
    - tito build --test --rpm --output rpms-fedora
    - createrepo rpms-fedora
  artifacts:
    paths:
      - rpms-fedora/

tito_centos8:
  stage: rpms
  image: registry.gitlab.com/kraxel/rpm-package-builder:centos8
  before_script:
    - dnf builddep -y *.spec
  script:
    - tito build --test --rpm --output rpms-centos8
    - createrepo rpms-centos8
  artifacts:
    paths:
      - rpms-centos8/

tito_centos7:
  stage: rpms
  image: registry.gitlab.com/kraxel/rpm-package-builder:centos7
  before_script:
    - dnf builddep -y *.spec
  script:
    - tito build --test --rpm --output rpms-centos7
    - createrepo rpms-centos7
  artifacts:
    paths:
      - rpms-centos7/

pages:
  stage: repo
  image: registry.gitlab.com/kraxel/rpm-package-builder:fedora
  dependencies:
    - tito_fedora
    - tito_centos8
    - tito_centos7
  script:
    - mkdir public
    - mv rpms-fedora public/fedora
    - mv rpms-centos8 public/centos8
    - mv rpms-centos7 public/centos7
    - dnf install -y tree
    - tree --charset utf8 -H . public > index.html
    - mv index.html public
  artifacts:
    paths:
      - public/
